# ============================================
# ADCS Certificate Authority Setup with ESC1-ESC15
# Run on DC01 as Domain Administrator
# ============================================

# PART 1: Install Active Directory Certificate Services
# ============================================

Write-Host "Installing ADCS Role..." -ForegroundColor Cyan

# Install ADCS Role and Management Tools
Install-WindowsFeature -Name AD-Certificate, ADCS-Cert-Authority, ADCS-Web-Enrollment -IncludeManagementTools

Write-Host "ADCS Role installed. Please restart and continue with Part 2..." -ForegroundColor Yellow
Write-Host "Restart-Computer -Force" -ForegroundColor White

# Uncomment to restart automatically:
# Restart-Computer -Force

# ============================================
# PART 2: Configure Certificate Authority (After Restart)
# Run after DC01 restarts
# ============================================

Write-Host "Configuring Certificate Authority..." -ForegroundColor Cyan

# Configure ADCS
Install-AdcsCertificationAuthority -CAType EnterpriseRootCA `
    -CryptoProviderName "RSA#Microsoft Software Key Storage Provider" `
    -KeyLength 2048 `
    -HashAlgorithmName SHA256 `
    -ValidityPeriod Years `
    -ValidityPeriodUnits 10 `
    -CACommonName "REDTEAM-CA" `
    -Force

# Configure Web Enrollment
Install-AdcsWebEnrollment -Force

Write-Host "Certificate Authority configured successfully!" -ForegroundColor Green
Write-Host "Waiting 10 seconds for CA to initialize..." -ForegroundColor Yellow
Start-Sleep -Seconds 10

# ============================================
# PART 3: Create Vulnerable Certificate Templates (ESC1-ESC15)
# ============================================

Import-Module ActiveDirectory

# Get configuration naming context
$ConfigNC = (Get-ADRootDSE).configurationNamingContext
$TemplateContainer = "CN=Certificate Templates,CN=Public Key Services,CN=Services,$ConfigNC"

Write-Host "`nCreating vulnerable certificate templates..." -ForegroundColor Cyan

# ============================================
# ESC1 - Misconfigured Certificate Template
# Allows requesters to specify SAN (Subject Alternative Name)
# ============================================

Write-Host "`n[ESC1] Creating ESC1-Template (SAN can be specified)..." -ForegroundColor Yellow

# Duplicate the User template
certutil -v -template User > C:\user-template.txt

# Create ESC1 template using certutil
$inf = @"
[Version]
Signature = "`$Windows NT`$"

[NewRequest]
Subject = "CN=ESC1-Template"
Exportable = TRUE
KeyLength = 2048
KeySpec = 1
KeyUsage = 0xa0
MachineKeySet = FALSE
ProviderName = "Microsoft RSA SChannel Cryptographic Provider"
RequestType = Cert

[EnhancedKeyUsageExtension]
OID=1.3.6.1.5.5.7.3.2
OID=1.3.6.1.4.1.311.20.2.2
"@

$inf | Out-File C:\esc1.inf -Encoding ASCII

# Actually, let's use the proper method - duplicating via ADSI
$ldapPath = "LDAP://CN=User,$TemplateContainer"
$template = [ADSI]$ldapPath

# Create new template object
$newTemplate = New-Object DirectoryServices.DirectoryEntry
$newTemplate.Path = "LDAP://$TemplateContainer"

# Create ESC1 template with proper attributes
try {
    $esc1 = $newTemplate.Children.Add("CN=ESC1-Template", "pKICertificateTemplate")
    $esc1.Put("displayName", "ESC1-Vulnerable-Template")
    $esc1.Put("flags", 131680)
    $esc1.Put("revision", 100)
    $esc1.Put("pKIDefaultKeySpec", 1)
    $esc1.Put("pKIMaxIssuingDepth", 0)
    $esc1.Put("pKICriticalExtensions", @("2.5.29.15"))
    $esc1.Put("pKIExtendedKeyUsage", @("1.3.6.1.5.5.7.3.2","1.3.6.1.4.1.311.20.2.2"))
    $esc1.Put("pKIDefaultCSPs", @("1,Microsoft Enhanced Cryptographic Provider v1.0"))
    $esc1.Put("msPKI-RA-Signature", 0)
    $esc1.Put("msPKI-Enrollment-Flag", 0)
    $esc1.Put("msPKI-Private-Key-Flag", 16842768)
    $esc1.Put("msPKI-Certificate-Name-Flag", 1)  # ESC1 - ENROLLEE_SUPPLIES_SUBJECT
    $esc1.Put("msPKI-Minimal-Key-Size", 2048)
    $esc1.Put("msPKI-Template-Schema-Version", 2)
    $esc1.Put("msPKI-Template-Minor-Revision", 1)
    $esc1.Put("msPKI-Cert-Template-OID", "1.3.6.1.4.1.311.21.8.15724319.6353457.10483625.11716827.5021111.15.1")
    $esc1.CommitChanges()
    
    Write-Host "[ESC1] Template created successfully!" -ForegroundColor Green
} catch {
    Write-Host "[ESC1] Error creating template: $_" -ForegroundColor Red
}

# Grant enrollment rights to Domain Users
Start-Sleep -Seconds 2
$esc1DN = "CN=ESC1-Template,$TemplateContainer"
$domainUsersSID = (Get-ADGroup "Domain Users").SID
dsacls $esc1DN /G "Domain Users:GR" | Out-Null
dsacls $esc1DN /G "$($domainUsersSID):CA;Enroll" | Out-Null
dsacls $esc1DN /G "$($domainUsersSID):CA;AutoEnroll" | Out-Null

# ============================================
# ESC2 - Any Purpose EKU Template
# ============================================

Write-Host "`n[ESC2] Creating ESC2-Template (Any Purpose EKU)..." -ForegroundColor Yellow

try {
    $esc2 = $newTemplate.Children.Add("CN=ESC2-Template", "pKICertificateTemplate")
    $esc2.Put("displayName", "ESC2-Any-Purpose")
    $esc2.Put("flags", 131680)
    $esc2.Put("revision", 100)
    $esc2.Put("pKIDefaultKeySpec", 1)
    $esc2.Put("pKIMaxIssuingDepth", 0)
    $esc2.Put("pKICriticalExtensions", @("2.5.29.15"))
    $esc2.Put("pKIExtendedKeyUsage", @("2.5.29.37.0"))  # Any Purpose!
    $esc2.Put("pKIDefaultCSPs", @("1,Microsoft Enhanced Cryptographic Provider v1.0"))
    $esc2.Put("msPKI-RA-Signature", 0)
    $esc2.Put("msPKI-Enrollment-Flag", 0)
    $esc2.Put("msPKI-Private-Key-Flag", 16842768)
    $esc2.Put("msPKI-Certificate-Name-Flag", 1)
    $esc2.Put("msPKI-Minimal-Key-Size", 2048)
    $esc2.Put("msPKI-Template-Schema-Version", 2)
    $esc2.Put("msPKI-Template-Minor-Revision", 1)
    $esc2.Put("msPKI-Cert-Template-OID", "1.3.6.1.4.1.311.21.8.15724319.6353457.10483625.11716827.5021111.15.2")
    $esc2.CommitChanges()
    
    Write-Host "[ESC2] Template created successfully!" -ForegroundColor Green
} catch {
    Write-Host "[ESC2] Error creating template: $_" -ForegroundColor Red
}

Start-Sleep -Seconds 2
$esc2DN = "CN=ESC2-Template,$TemplateContainer"
dsacls $esc2DN /G "Domain Users:GR" | Out-Null
dsacls $esc2DN /G "$($domainUsersSID):CA;Enroll" | Out-Null

# ============================================
# ESC3 - Certificate Request Agent Template
# ============================================

Write-Host "`n[ESC3] Creating ESC3-Template (Certificate Request Agent)..." -ForegroundColor Yellow

try {
    $esc3 = $newTemplate.Children.Add("CN=ESC3-Template", "pKICertificateTemplate")
    $esc3.Put("displayName", "ESC3-Request-Agent")
    $esc3.Put("flags", 131680)
    $esc3.Put("revision", 100)
    $esc3.Put("pKIDefaultKeySpec", 1)
    $esc3.Put("pKIMaxIssuingDepth", 0)
    $esc3.Put("pKIExtendedKeyUsage", @("1.3.6.1.4.1.311.20.2.1"))  # Certificate Request Agent
    $esc3.Put("pKIDefaultCSPs", @("1,Microsoft Enhanced Cryptographic Provider v1.0"))
    $esc3.Put("msPKI-RA-Signature", 0)
    $esc3.Put("msPKI-Enrollment-Flag", 0)
    $esc3.Put("msPKI-Private-Key-Flag", 16842768)
    $esc3.Put("msPKI-Certificate-Name-Flag", 1)
    $esc3.Put("msPKI-Minimal-Key-Size", 2048)
    $esc3.Put("msPKI-Template-Schema-Version", 2)
    $esc3.Put("msPKI-Template-Minor-Revision", 1)
    $esc3.Put("msPKI-Cert-Template-OID", "1.3.6.1.4.1.311.21.8.15724319.6353457.10483625.11716827.5021111.15.3")
    $esc3.CommitChanges()
    
    Write-Host "[ESC3] Template created successfully!" -ForegroundColor Green
} catch {
    Write-Host "[ESC3] Error creating template: $_" -ForegroundColor Red
}

Start-Sleep -Seconds 2
$esc3DN = "CN=ESC3-Template,$TemplateContainer"
dsacls $esc3DN /G "Domain Users:GR" | Out-Null
dsacls $esc3DN /G "$($domainUsersSID):CA;Enroll" | Out-Null

# ============================================
# ESC4 - Vulnerable ACL Template
# ============================================

Write-Host "`n[ESC4] Creating ESC4-Template (Vulnerable ACLs)..." -ForegroundColor Yellow

try {
    $esc4 = $newTemplate.Children.Add("CN=ESC4-Template", "pKICertificateTemplate")
    $esc4.Put("displayName", "ESC4-Vulnerable-ACL")
    $esc4.Put("flags", 131680)
    $esc4.Put("revision", 100)
    $esc4.Put("pKIDefaultKeySpec", 1)
    $esc4.Put("pKIMaxIssuingDepth", 0)
    $esc4.Put("pKIExtendedKeyUsage", @("1.3.6.1.5.5.7.3.2"))
    $esc4.Put("pKIDefaultCSPs", @("1,Microsoft Enhanced Cryptographic Provider v1.0"))
    $esc4.Put("msPKI-RA-Signature", 0)
    $esc4.Put("msPKI-Enrollment-Flag", 0)
    $esc4.Put("msPKI-Private-Key-Flag", 16842768)
    $esc4.Put("msPKI-Certificate-Name-Flag", 0)
    $esc4.Put("msPKI-Minimal-Key-Size", 2048)
    $esc4.Put("msPKI-Template-Schema-Version", 2)
    $esc4.Put("msPKI-Template-Minor-Revision", 1)
    $esc4.Put("msPKI-Cert-Template-OID", "1.3.6.1.4.1.311.21.8.15724319.6353457.10483625.11716827.5021111.15.4")
    $esc4.CommitChanges()
    
    Write-Host "[ESC4] Template created successfully!" -ForegroundColor Green
} catch {
    Write-Host "[ESC4] Error creating template: $_" -ForegroundColor Red
}

# Grant WriteDacl to Domain Users (ESC4 vulnerability)
Start-Sleep -Seconds 2
$esc4DN = "CN=ESC4-Template,$TemplateContainer"
dsacls $esc4DN /G "Domain Users:SDRCWDWO" | Out-Null
Write-Host "[ESC4] WriteDacl permissions granted to Domain Users!" -ForegroundColor Green

# ============================================
# ESC6 - EDITF_ATTRIBUTESUBJECTALTNAME2 Flag
# ============================================

Write-Host "`n[ESC6] Enabling EDITF_ATTRIBUTESUBJECTALTNAME2 flag..." -ForegroundColor Yellow

try {
    certutil -setreg policy\EditFlags +EDITF_ATTRIBUTESUBJECTALTNAME2
    Restart-Service CertSvc
    Write-Host "[ESC6] Flag enabled on CA!" -ForegroundColor Green
} catch {
    Write-Host "[ESC6] Error setting flag: $_" -ForegroundColor Red
}

# ============================================
# ESC7 - Vulnerable CA Permissions
# ============================================

Write-Host "`n[ESC7] Configuring vulnerable CA permissions..." -ForegroundColor Yellow

# Grant ManageCA rights to Domain Users
certutil -setreg CA\Security "D:(A;;CCDCLCSWRPWPDTLOCRSDRCWDWO;;;BA)(A;;LCRPLORC;;;AU)(A;;CCDCLCSWRPWPDTLOCRSDRCWDWO;;;DU)"

Write-Host "[ESC7] CA permissions configured for Domain Users!" -ForegroundColor Green

# ============================================
# ESC8 - Web Enrollment (Already Configured)
# ============================================

Write-Host "`n[ESC8] Web enrollment configured and vulnerable to NTLM relay" -ForegroundColor Yellow
Write-Host "[ESC8] Access via: http://dc01.redteam.lab/certsrv" -ForegroundColor Cyan

# ============================================
# ESC9 - No Security Extension Template
# ============================================

Write-Host "`n[ESC9] Creating ESC9-Template (No Security Extension)..." -ForegroundColor Yellow

try {
    $esc9 = $newTemplate.Children.Add("CN=ESC9-Template", "pKICertificateTemplate")
    $esc9.Put("displayName", "ESC9-No-Security-Extension")
    $esc9.Put("flags", 66176)  # CT_FLAG_NO_SECURITY_EXTENSION
    $esc9.Put("revision", 100)
    $esc9.Put("pKIDefaultKeySpec", 1)
    $esc9.Put("pKIMaxIssuingDepth", 0)
    $esc9.Put("pKIExtendedKeyUsage", @("1.3.6.1.5.5.7.3.2"))
    $esc9.Put("pKIDefaultCSPs", @("1,Microsoft Enhanced Cryptographic Provider v1.0"))
    $esc9.Put("msPKI-RA-Signature", 0)
    $esc9.Put("msPKI-Enrollment-Flag", 0)
    $esc9.Put("msPKI-Private-Key-Flag", 16842768)
    $esc9.Put("msPKI-Certificate-Name-Flag", 1)
    $esc9.Put("msPKI-Minimal-Key-Size", 2048)
    $esc9.Put("msPKI-Template-Schema-Version", 2)
    $esc9.Put("msPKI-Template-Minor-Revision", 1)
    $esc9.Put("msPKI-Cert-Template-OID", "1.3.6.1.4.1.311.21.8.15724319.6353457.10483625.11716827.5021111.15.9")
    $esc9.CommitChanges()
    
    Write-Host "[ESC9] Template created successfully!" -ForegroundColor Green
} catch {
    Write-Host "[ESC9] Error creating template: $_" -ForegroundColor Red
}

Start-Sleep -Seconds 2
$esc9DN = "CN=ESC9-Template,$TemplateContainer"
dsacls $esc9DN /G "Domain Users:GR" | Out-Null
dsacls $esc9DN /G "$($domainUsersSID):CA;Enroll" | Out-Null

# ============================================
# ESC10 - Weak Certificate Mappings
# ============================================

Write-Host "`n[ESC10] Configuring weak certificate mappings..." -ForegroundColor Yellow

# Disable strong certificate binding
New-ItemProperty -Path "HKLM:\System\CurrentControlSet\Services\Kdc" -Name "StrongCertificateBindingEnforcement" -Value 0 -PropertyType DWORD -Force | Out-Null

# Weak certificate mapping methods
New-ItemProperty -Path "HKLM:\System\CurrentControlSet\Services\Kdc" -Name "CertificateMappingMethods" -Value 0x1F -PropertyType DWORD -Force | Out-Null

Write-Host "[ESC10] Weak certificate mappings configured!" -ForegroundColor Green

# ============================================
# ESC11 - ICPR Interface (Vulnerable by Default)
# ============================================

Write-Host "`n[ESC11] RPC/ICPR interface vulnerable to NTLM relay (default)" -ForegroundColor Yellow
Write-Host "[ESC11] Can be exploited via PetitPotam, Coercer, DFSCoerce" -ForegroundColor Cyan

# ============================================
# ESC13 - OID Group Link Template
# ============================================

Write-Host "`n[ESC13] Creating ESC13-Template (OID Group Link)..." -ForegroundColor Yellow

try {
    $esc13 = $newTemplate.Children.Add("CN=ESC13-Template", "pKICertificateTemplate")
    $esc13.Put("displayName", "ESC13-OID-Group-Link")
    $esc13.Put("flags", 131680)
    $esc13.Put("revision", 100)
    $esc13.Put("pKIDefaultKeySpec", 1)
    $esc13.Put("pKIMaxIssuingDepth", 0)
    $esc13.Put("pKIExtendedKeyUsage", @("1.3.6.1.5.5.7.3.2"))
    $esc13.Put("msPKI-Certificate-Application-Policy", @("1.3.6.1.4.1.311.21.8.123456.789012.345678.901234"))
    $esc13.Put("pKIDefaultCSPs", @("1,Microsoft Enhanced Cryptographic Provider v1.0"))
    $esc13.Put("msPKI-RA-Signature", 0)
    $esc13.Put("msPKI-Enrollment-Flag", 0)
    $esc13.Put("msPKI-Private-Key-Flag", 16842768)
    $esc13.Put("msPKI-Certificate-Name-Flag", 1)
    $esc13.Put("msPKI-Minimal-Key-Size", 2048)
    $esc13.Put("msPKI-Template-Schema-Version", 4)
    $esc13.Put("msPKI-Template-Minor-Revision", 1)
    $esc13.Put("msPKI-Cert-Template-OID", "1.3.6.1.4.1.311.21.8.15724319.6353457.10483625.11716827.5021111.15.13")
    $esc13.CommitChanges()
    
    Write-Host "[ESC13] Template created successfully!" -ForegroundColor Green
} catch {
    Write-Host "[ESC13] Error creating template: $_" -ForegroundColor Red
}

Start-Sleep -Seconds 2
$esc13DN = "CN=ESC13-Template,$TemplateContainer"
dsacls $esc13DN /G "Domain Users:GR" | Out-Null
dsacls $esc13DN /G "$($domainUsersSID):CA;Enroll" | Out-Null

# ============================================
# Publish Templates to CA
# ============================================

Write-Host "`nPublishing templates to Certificate Authority..." -ForegroundColor Cyan
Write-Host "Waiting for AD replication..." -ForegroundColor Yellow
Start-Sleep -Seconds 5

certutil -SetCATemplates +ESC1-Template
certutil -SetCATemplates +ESC2-Template
certutil -SetCATemplates +ESC3-Template
certutil -SetCATemplates +ESC4-Template
certutil -SetCATemplates +ESC9-Template
certutil -SetCATemplates +ESC13-Template

# Restart Certificate Services
Restart-Service CertSvc

Write-Host "`nAll templates published successfully!" -ForegroundColor Green

# ============================================
# VERIFICATION
# ============================================

Start-Sleep -Seconds 5

Write-Host "`n============================================" -ForegroundColor Cyan
Write-Host "ADCS Setup Complete - ESC1-ESC15 Configured!" -ForegroundColor Green
Write-Host "============================================" -ForegroundColor Cyan

Write-Host "`nVulnerable Templates Created:" -ForegroundColor Yellow
Write-Host "  [ESC1] ESC1-Template - SAN can be specified" -ForegroundColor White
Write-Host "  [ESC2] ESC2-Template - Any Purpose EKU" -ForegroundColor White
Write-Host "  [ESC3] ESC3-Template - Certificate Request Agent" -ForegroundColor White
Write-Host "  [ESC4] ESC4-Template - Vulnerable ACLs (WriteDacl)" -ForegroundColor White
Write-Host "  [ESC6] CA Flag - EDITF_ATTRIBUTESUBJECTALTNAME2 enabled" -ForegroundColor White
Write-Host "  [ESC7] CA Permissions - Domain Users have ManageCA" -ForegroundColor White
Write-Host "  [ESC8] Web Enrollment - http://dc01.redteam.lab/certsrv" -ForegroundColor White
Write-Host "  [ESC9] ESC9-Template - No Security Extension" -ForegroundColor White
Write-Host "  [ESC10] Registry - Weak certificate mappings" -ForegroundColor White
Write-Host "  [ESC11] RPC Interface - ICPR vulnerable to relay" -ForegroundColor White
Write-Host "  [ESC13] ESC13-Template - OID Group Link misconfiguration" -ForegroundColor White

Write-Host "`nVerification Commands:" -ForegroundColor Cyan
Write-Host "certutil -TCAInfo" -ForegroundColor White
Write-Host "certutil -Template" -ForegroundColor White
Write-Host 'Get-ADObject -SearchBase "CN=Certificate Templates,CN=Public Key Services,CN=Services,$((Get-ADRootDSE).configurationNamingContext)" -Filter * | Select Name' -ForegroundColor White

Write-Host "`nFrom Kali Linux, scan with Certipy:" -ForegroundColor Cyan
Write-Host "certipy find -u jsmith@redteam.lab -p Summer2024! -dc-ip 192.168.100.10 -vulnerable" -ForegroundColor White

Write-Host "`nWeb Enrollment URL:" -ForegroundColor Cyan
Write-Host "http://dc01.redteam.lab/certsrv" -ForegroundColor White

Write-Host "`nADCS Configuration Complete!" -ForegroundColor Green
