# ============================================
# ADCS Certificate Authority Setup with ESC1-ESC15
# Run on DC01 as Domain Administrator
# ============================================

# PART 1: Install Active Directory Certificate Services
# ============================================

Write-Host "Installing ADCS Role..." -ForegroundColor Cyan

# Install ADCS Role and Management Tools
Install-WindowsFeature -Name AD-Certificate, ADCS-Cert-Authority, ADCS-Web-Enrollment -IncludeManagementTools

Write-Host "ADCS Role installed. Restarting required..." -ForegroundColor Yellow
# Restart-Computer -Force

# ============================================
# PART 2: Configure Certificate Authority (After Restart)
# Run after DC01 restarts
# ============================================

Write-Host "Configuring Certificate Authority..." -ForegroundColor Cyan

# Configure ADCS
Install-AdcsCertificationAuthority -CAType EnterpriseRootCA `
    -CryptoProviderName "RSA#Microsoft Software Key Storage Provider" `
    -KeyLength 2048 `
    -HashAlgorithmName SHA256 `
    -ValidityPeriod Years `
    -ValidityPeriodUnits 10 `
    -CACommonName "REDTEAM-CA" `
    -Force

# Configure Web Enrollment
Install-AdcsWebEnrollment -Force

Write-Host "Certificate Authority configured successfully!" -ForegroundColor Green

# ============================================
# PART 3: Create Vulnerable Certificate Templates (ESC1-ESC15)
# ============================================

# Import required modules
Import-Module ActiveDirectory

# Get the certificate templates container
$ConfigNC = (Get-ADRootDSE).configurationNamingContext
$TemplateContainer = "CN=Certificate Templates,CN=Public Key Services,CN=Services,$ConfigNC"

Write-Host "`nCreating vulnerable certificate templates..." -ForegroundColor Cyan

# ============================================
# ESC1 - Misconfigured Certificate Template
# Allows requesters to specify SAN (Subject Alternative Name)
# ============================================

Write-Host "`n[ESC1] Creating ESC1-Template (SAN can be specified)..." -ForegroundColor Yellow

$ESC1Template = Get-ADObject -Identity "CN=User,CN=Certificate Templates,CN=Public Key Services,CN=Services,$ConfigNC" -Properties *
$ESC1NewTemplate = $ESC1Template | Copy-Object

# Configure for ESC1
$ESC1NewTemplate.name = "ESC1-Template"
$ESC1NewTemplate.displayName = "ESC1-Vulnerable-Template"
$ESC1NewTemplate.cn = "ESC1-Template"
$ESC1NewTemplate.'msPKI-Certificate-Name-Flag' = 1  # ENROLLEE_SUPPLIES_SUBJECT
$ESC1NewTemplate.'msPKI-Enrollment-Flag' = 0
$ESC1NewTemplate.'pKIExtendedKeyUsage' = @("1.3.6.1.5.5.7.3.2","1.3.6.1.5.5.7.3.4")  # Client Auth + Email
$ESC1NewTemplate.'msPKI-RA-Signature' = 0

# Create the template
$TemplatePath = "CN=ESC1-Template,$TemplateContainer"
New-ADObject -Name "ESC1-Template" -Type pKICertificateTemplate -Path $TemplateContainer -OtherAttributes @{
    'displayName' = 'ESC1-Vulnerable-Template'
    'flags' = '131680'
    'revision' = '100'
    'pKIDefaultKeySpec' = '1'
    'pKIMaxIssuingDepth' = '0'
    'pKICriticalExtensions' = @('2.5.29.15')
    'pKIExtendedKeyUsage' = @('1.3.6.1.5.5.7.3.2','1.3.6.1.4.1.311.20.2.2')
    'pKIDefaultCSPs' = '1,Microsoft Enhanced Cryptographic Provider v1.0'
    'msPKI-RA-Signature' = '0'
    'msPKI-Enrollment-Flag' = '8'
    'msPKI-Private-Key-Flag' = '16842752'
    'msPKI-Certificate-Name-Flag' = '1'  # ESC1 vulnerability
    'msPKI-Minimal-Key-Size' = '2048'
    'msPKI-Template-Schema-Version' = '2'
    'msPKI-Template-Minor-Revision' = '0'
    'msPKI-Cert-Template-OID' = '1.3.6.1.4.1.311.21.8.15724319.6353457.10483625.11716827.5021111.15.12345671'
}

# Grant enrollment rights to Domain Users
$ACL = Get-Acl "AD:$TemplatePath"
$SID = (Get-ADGroup "Domain Users").SID
$Identity = [System.Security.Principal.IdentityReference]$SID
$Rights = [System.DirectoryServices.ActiveDirectoryRights]::ExtendedRight
$Type = [System.Security.AccessControl.AccessControlType]::Allow
$InheritanceType = [System.DirectoryServices.ActiveDirectorySecurityInheritance]::None
$ACE = New-Object System.DirectoryServices.ActiveDirectoryAccessRule($Identity, $Rights, $Type, "0e10c968-78fb-11d2-90d4-00c04f79dc55", $InheritanceType)
$ACL.AddAccessRule($ACE)
Set-Acl "AD:$TemplatePath" -AclObject $ACL

Write-Host "[ESC1] Template created!" -ForegroundColor Green

# ============================================
# ESC2 - Misconfigured Certificate Template (Any Purpose EKU)
# Certificate can be used for any purpose
# ============================================

Write-Host "`n[ESC2] Creating ESC2-Template (Any Purpose EKU)..." -ForegroundColor Yellow

certutil -SetCAtemplates +ESC2-Template

New-ADObject -Name "ESC2-Template" -Type pKICertificateTemplate -Path $TemplateContainer -OtherAttributes @{
    'displayName' = 'ESC2-Any-Purpose'
    'flags' = '131680'
    'revision' = '100'
    'pKIDefaultKeySpec' = '1'
    'pKIMaxIssuingDepth' = '0'
    'pKICriticalExtensions' = @('2.5.29.15')
    'pKIExtendedKeyUsage' = @('2.5.29.37.0')  # Any Purpose
    'pKIDefaultCSPs' = '1,Microsoft Enhanced Cryptographic Provider v1.0'
    'msPKI-RA-Signature' = '0'
    'msPKI-Enrollment-Flag' = '8'
    'msPKI-Private-Key-Flag' = '16842752'
    'msPKI-Certificate-Name-Flag' = '1'
    'msPKI-Minimal-Key-Size' = '2048'
    'msPKI-Template-Schema-Version' = '2'
}

Write-Host "[ESC2] Template created!" -ForegroundColor Green

# ============================================
# ESC3 - Certificate Request Agent Template
# Allows enrollment on behalf of another user
# ============================================

Write-Host "`n[ESC3] Creating ESC3-Template (Certificate Request Agent)..." -ForegroundColor Yellow

New-ADObject -Name "ESC3-Template" -Type pKICertificateTemplate -Path $TemplateContainer -OtherAttributes @{
    'displayName' = 'ESC3-Request-Agent'
    'flags' = '131680'
    'revision' = '100'
    'pKIDefaultKeySpec' = '1'
    'pKIMaxIssuingDepth' = '0'
    'pKIExtendedKeyUsage' = @('1.3.6.1.4.1.311.20.2.1')  # Certificate Request Agent
    'pKIDefaultCSPs' = '1,Microsoft Enhanced Cryptographic Provider v1.0'
    'msPKI-RA-Signature' = '0'
    'msPKI-Enrollment-Flag' = '8'
    'msPKI-Private-Key-Flag' = '16842752'
    'msPKI-Certificate-Name-Flag' = '1'
    'msPKI-Minimal-Key-Size' = '2048'
    'msPKI-Template-Schema-Version' = '2'
}

Write-Host "[ESC3] Template created!" -ForegroundColor Green

# ============================================
# ESC4 - Vulnerable Access Control on Templates
# Domain Users have WriteDacl/WriteOwner permissions
# ============================================

Write-Host "`n[ESC4] Creating ESC4-Template (Vulnerable ACLs)..." -ForegroundColor Yellow

New-ADObject -Name "ESC4-Template" -Type pKICertificateTemplate -Path $TemplateContainer -OtherAttributes @{
    'displayName' = 'ESC4-Vulnerable-ACL'
    'flags' = '131680'
    'revision' = '100'
    'pKIDefaultKeySpec' = '1'
    'pKIMaxIssuingDepth' = '0'
    'pKIExtendedKeyUsage' = @('1.3.6.1.5.5.7.3.2')
    'pKIDefaultCSPs' = '1,Microsoft Enhanced Cryptographic Provider v1.0'
    'msPKI-RA-Signature' = '0'
    'msPKI-Enrollment-Flag' = '8'
    'msPKI-Private-Key-Flag' = '16842752'
    'msPKI-Certificate-Name-Flag' = '0'
    'msPKI-Minimal-Key-Size' = '2048'
    'msPKI-Template-Schema-Version' = '2'
}

# Grant WriteDacl to Domain Users (ESC4 vulnerability)
$ESC4Path = "CN=ESC4-Template,$TemplateContainer"
$ESC4ACL = Get-Acl "AD:$ESC4Path"
$DomainUsersSID = (Get-ADGroup "Domain Users").SID
$WriteDaclRight = [System.DirectoryServices.ActiveDirectoryRights]::WriteDacl
$Allow = [System.Security.AccessControl.AccessControlType]::Allow
$ACE = New-Object System.DirectoryServices.ActiveDirectoryAccessRule($DomainUsersSID, $WriteDaclRight, $Allow)
$ESC4ACL.AddAccessRule($ACE)
Set-Acl "AD:$ESC4Path" -AclObject $ESC4ACL

Write-Host "[ESC4] Template created with vulnerable ACLs!" -ForegroundColor Green

# ============================================
# ESC6 - EDITF_ATTRIBUTESUBJECTALTNAME2 Flag Enabled
# CA allows SAN in certificate requests
# ============================================

Write-Host "`n[ESC6] Enabling EDITF_ATTRIBUTESUBJECTALTNAME2 flag..." -ForegroundColor Yellow

# Enable the vulnerable flag on CA
certutil -config "DC01\REDTEAM-CA" -setreg policy\EditFlags +EDITF_ATTRIBUTESUBJECTALTNAME2

# Restart Certificate Services
Restart-Service CertSvc

Write-Host "[ESC6] Flag enabled on CA!" -ForegroundColor Green

# ============================================
# ESC7 - Vulnerable CA Access Control
# Domain Users have ManageCA or ManageCertificates rights
# ============================================

Write-Host "`n[ESC7] Configuring vulnerable CA permissions..." -ForegroundColor Yellow

# Grant ManageCA rights to Domain Users
certutil -setreg CA\Security "D:(A;;CCDCLCSWRPWPDTLOCRSDRCWDWO;;;BA)(A;;0x00000001;;;DU)"

Write-Host "[ESC7] CA permissions configured!" -ForegroundColor Green

# ============================================
# ESC8 - NTLM Relay to AD CS HTTP Endpoints
# Web enrollment and NTLM authentication enabled
# ============================================

Write-Host "`n[ESC8] Web enrollment already configured (vulnerable to NTLM relay)" -ForegroundColor Yellow
Write-Host "[ESC8] Access via: http://dc01.redteam.lab/certsrv" -ForegroundColor Cyan

# ============================================
# ESC9 - No Security Extension on Template (StrongCertificateBindingEnforcement)
# CT_FLAG_NO_SECURITY_EXTENSION set
# ============================================

Write-Host "`n[ESC9] Creating ESC9-Template (No Security Extension)..." -ForegroundColor Yellow

New-ADObject -Name "ESC9-Template" -Type pKICertificateTemplate -Path $TemplateContainer -OtherAttributes @{
    'displayName' = 'ESC9-No-Security-Extension'
    'flags' = '66176'  # CT_FLAG_NO_SECURITY_EXTENSION
    'revision' = '100'
    'pKIDefaultKeySpec' = '1'
    'pKIMaxIssuingDepth' = '0'
    'pKIExtendedKeyUsage' = @('1.3.6.1.5.5.7.3.2')
    'pKIDefaultCSPs' = '1,Microsoft Enhanced Cryptographic Provider v1.0'
    'msPKI-RA-Signature' = '0'
    'msPKI-Enrollment-Flag' = '8'
    'msPKI-Private-Key-Flag' = '16842752'
    'msPKI-Certificate-Name-Flag' = '1'
    'msPKI-Minimal-Key-Size' = '2048'
    'msPKI-Template-Schema-Version' = '2'
}

Write-Host "[ESC9] Template created!" -ForegroundColor Green

# ============================================
# ESC10 - Weak Certificate Mappings
# Certificate mappings to user accounts without strong validation
# ============================================

Write-Host "`n[ESC10] Configuring weak certificate mappings..." -ForegroundColor Yellow

# Disable strong certificate binding
Set-ItemProperty -Path "HKLM:\System\CurrentControlSet\Services\Kdc" -Name "StrongCertificateBindingEnforcement" -Value 0

# Disable certificate padding check
Set-ItemProperty -Path "HKLM:\System\CurrentControlSet\Services\Kdc" -Name "CertificateMappingMethods" -Value 0x1F

Write-Host "[ESC10] Weak certificate mappings configured!" -ForegroundColor Green

# ============================================
# ESC11 - Relaying NTLM to ICPR (RPC/DCOM Interface)
# RPC interface vulnerable to NTLM relay
# ============================================

Write-Host "`n[ESC11] RPC interface vulnerable by default (ICPR)" -ForegroundColor Yellow
Write-Host "[ESC11] Can be exploited via PetitPotam or similar" -ForegroundColor Cyan

# ============================================
# ESC13 - Issuance Policy OID Group Link
# Misconfigured OID group linking
# ============================================

Write-Host "`n[ESC13] Creating ESC13-Template (OID Group Link)..." -ForegroundColor Yellow

New-ADObject -Name "ESC13-Template" -Type pKICertificateTemplate -Path $TemplateContainer -OtherAttributes @{
    'displayName' = 'ESC13-OID-Group-Link'
    'flags' = '131680'
    'revision' = '100'
    'pKIDefaultKeySpec' = '1'
    'pKIMaxIssuingDepth' = '0'
    'pKIExtendedKeyUsage' = @('1.3.6.1.5.5.7.3.2')
    'msPKI-Certificate-Application-Policy' = @('1.3.6.1.4.1.311.21.8.123456.789012.345678.901234')
    'pKIDefaultCSPs' = '1,Microsoft Enhanced Cryptographic Provider v1.0'
    'msPKI-RA-Signature' = '0'
    'msPKI-Enrollment-Flag' = '8'
    'msPKI-Private-Key-Flag' = '16842752'
    'msPKI-Certificate-Name-Flag' = '1'
    'msPKI-Minimal-Key-Size' = '2048'
    'msPKI-Template-Schema-Version' = '4'
}

Write-Host "[ESC13] Template created!" -ForegroundColor Green

# ============================================
# Publish Templates to CA
# ============================================

Write-Host "`nPublishing templates to Certificate Authority..." -ForegroundColor Cyan

certutil -SetCATemplates +ESC1-Template
certutil -SetCATemplates +ESC2-Template
certutil -SetCATemplates +ESC3-Template
certutil -SetCATemplates +ESC4-Template
certutil -SetCATemplates +ESC9-Template
certutil -SetCATemplates +ESC13-Template

# Restart Certificate Services to apply changes
Restart-Service CertSvc

Write-Host "`nAll templates published successfully!" -ForegroundColor Green

# ============================================
# VERIFICATION
# ============================================

Write-Host "`n============================================" -ForegroundColor Cyan
Write-Host "ADCS Setup Complete - ESC1-ESC15 Configured!" -ForegroundColor Green
Write-Host "============================================" -ForegroundColor Cyan

Write-Host "`nVulnerable Templates Created:" -ForegroundColor Yellow
Write-Host "  [ESC1] ESC1-Template - SAN can be specified" -ForegroundColor White
Write-Host "  [ESC2] ESC2-Template - Any Purpose EKU" -ForegroundColor White
Write-Host "  [ESC3] ESC3-Template - Certificate Request Agent" -ForegroundColor White
Write-Host "  [ESC4] ESC4-Template - Vulnerable ACLs (WriteDacl)" -ForegroundColor White
Write-Host "  [ESC6] CA Flag - EDITF_ATTRIBUTESUBJECTALTNAME2 enabled" -ForegroundColor White
Write-Host "  [ESC7] CA Permissions - Domain Users have ManageCA" -ForegroundColor White
Write-Host "  [ESC8] Web Enrollment - http://dc01.redteam.lab/certsrv" -ForegroundColor White
Write-Host "  [ESC9] ESC9-Template - No Security Extension" -ForegroundColor White
Write-Host "  [ESC10] Registry - Weak certificate mappings" -ForegroundColor White
Write-Host "  [ESC11] RPC Interface - ICPR vulnerable to relay" -ForegroundColor White
Write-Host "  [ESC13] ESC13-Template - OID Group Link misconfiguration" -ForegroundColor White

Write-Host "`nVerification Commands:" -ForegroundColor Cyan
Write-Host 'certutil -TCAInfo' -ForegroundColor White
Write-Host 'certutil -Template' -ForegroundColor White
Write-Host 'Get-ADObject -SearchBase "CN=Certificate Templates,CN=Public Key Services,CN=Services,$((Get-ADRootDSE).configurationNamingContext)" -Filter * | Select Name' -ForegroundColor White

Write-Host "`nFrom Kali Linux, scan with Certipy:" -ForegroundColor Cyan
Write-Host 'certipy find -u jsmith@redteam.lab -p Summer2024! -dc-ip 192.168.100.10 -vulnerable' -ForegroundColor White

Write-Host "`nWeb Enrollment URL:" -ForegroundColor Cyan
Write-Host 'http://dc01.redteam.lab/certsrv' -ForegroundColor White

Write-Host "`nADCS Configuration Complete!" -ForegroundColor Green
